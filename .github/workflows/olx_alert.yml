name: OLX Telegram Alerts

on:
  schedule:
    - cron: "*/10 * * * *"  # La fiecare 10 minute (pentru punctualitate maximÄƒ)
  workflow_dispatch:

jobs:
  crawl:
    concurrency:
      group: olx-alerts
      cancel-in-progress: false

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Restore state cache
        id: cache-state
        uses: actions/cache/restore@v4
        with:
          path: state.json
          key: dummy
          restore-keys: |
            olx-state-

      - name: Show state BEFORE
        run: |
          if [ -f state.json ]; then
            echo "state.json exists BEFORE. Size:" $(wc -c < state.json)
            echo "Preview:"
            head -c 200 state.json || true
            echo ""
          else
            echo "state.json NOT FOUND (fresh run)"
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run spider (Canon)
        env:
          SEARCH_URL:          ${{ secrets.SEARCH_URL_CANON }}
          TELEGRAM_BOT_TOKEN:  ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:    ${{ secrets.TELEGRAM_CHAT_ID }}
        run: scrapy crawl watch -s LOG_LEVEL=INFO

      - name: Run spider (Nikon)
        env:
          SEARCH_URL:          ${{ secrets.SEARCH_URL_NIKON }}
          TELEGRAM_BOT_TOKEN:  ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:    ${{ secrets.TELEGRAM_CHAT_ID }}
        run: scrapy crawl watch -s LOG_LEVEL=INFO

      - name: Run spider (Sony)
        env:
          SEARCH_URL:          ${{ secrets.SEARCH_URL_SONY }}
          TELEGRAM_BOT_TOKEN:  ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:    ${{ secrets.TELEGRAM_CHAT_ID }}
        run: scrapy crawl watch -s LOG_LEVEL=INFO

      - name: Run spider (Aparat Foto)
        env:
          SEARCH_URL:          ${{ secrets.SEARCH_URL_APARAT_FOTO }}
          TELEGRAM_BOT_TOKEN:  ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:    ${{ secrets.TELEGRAM_CHAT_ID }}
        run: scrapy crawl watch -s LOG_LEVEL=INFO

      - name: Run spider (Camera Foto)
        env:
          SEARCH_URL:          ${{ secrets.SEARCH_URL_CAMERA_FOTO }}
          TELEGRAM_BOT_TOKEN:  ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:    ${{ secrets.TELEGRAM_CHAT_ID }}
        run: scrapy crawl watch -s LOG_LEVEL=INFO

      - name: Show state AFTER
        run: |
          if [ -f state.json ]; then
            echo "state.json exists AFTER. Size:" $(wc -c < state.json)
            echo "Preview:"
            head -c 200 state.json || true
            echo ""
          else
            echo "state.json missing AFTER runs (unexpected)"
          fi

      - name: Save state cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: state.json
          key: olx-state-${{ github.run_id }}
