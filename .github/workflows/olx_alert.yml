name: OLX Telegram Alerts

on:
  schedule:
    # ruleazÄƒ din 5 Ã®n 5 minute (ora UTC)
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  crawl:
    # nu anulÄƒm un job aflat Ã®n derulare (deduplicarea are nevoie sÄƒ termine)
    concurrency:
      group: olx-alerts         # acelaÈ™i grup â†’ un singur job simultan
      cancel-in-progress: false # <-- ADÄ‚UGAT: nu tÄƒia un run Ã®n curs

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # 1ï¸âƒ£ RESTORE â€” aducem state.json din cache (dacÄƒ existÄƒ)
      - name: Restore state cache
        id: cache-state
        uses: actions/cache/restore@v4
        with:
          path: state.json
          # key obligatoriu (nu trebuie sÄƒ existe); restore-keys cautÄƒ cea mai nouÄƒ potrivire
          key: dummy
          restore-keys: |
            olx-state-

      # ðŸ” DEBUG: aratÄƒ dacÄƒ s-a restaurat ceva
      - name: Show state BEFORE
        run: |
          if [ -f state.json ]; then
            echo "state.json exists BEFORE. Size:" $(wc -c < state.json)
            echo "Preview:"
            head -c 200 state.json || true
            echo ""
          else
            echo "state.json NOT FOUND (fresh run)"
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -r requirements.txt

      # 2ï¸âƒ£ Spider OLX â€“ SONY
      - name: Run spider (SONY)
        env:
          SEARCH_URL:          ${{ secrets.SEARCH_URL_SONY }}
          TELEGRAM_BOT_TOKEN:  ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:    ${{ secrets.TELEGRAM_CHAT_ID }}
        run: scrapy crawl watch

      # 2ï¸âƒ£ Spider OLX â€“ Camera foto
      - name: Run spider (Camera Foto)
        env:
          SEARCH_URL:          ${{ secrets.SEARCH_URL_CAMERA_FOTO }}
          TELEGRAM_BOT_TOKEN:  ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:    ${{ secrets.TELEGRAM_CHAT_ID }}
        run: scrapy crawl watch

      # 3ï¸âƒ£ Spider OLX â€“ Aparat foto
      - name: Run spider (APARAT FOTO)
        env:
          SEARCH_URL:          ${{ secrets.SEARCH_URL_APARAT_FOTO }}
          TELEGRAM_BOT_TOKEN:  ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:    ${{ secrets.TELEGRAM_CHAT_ID }}
        run: scrapy crawl watch

      # ðŸ” DEBUG: vezi cum aratÄƒ dupÄƒ rulari
      - name: Show state AFTER
        run: |
          if [ -f state.json ]; then
            echo "state.json exists AFTER. Size:" $(wc -c < state.json)
            echo "Preview:"
            head -c 200 state.json || true
            echo ""
          else
            echo "state.json missing AFTER runs (unexpected)"
          fi

      # 4ï¸âƒ£ SAVE â€” Ã®ncÄƒrcÄƒm state.json actualizat Ã®n cache (cheie unicÄƒ pe run_id)
      - name: Save state cache
        uses: actions/cache/save@v4
        if: always()            # ruleazÄƒ chiar dacÄƒ spiderul gÄƒseÈ™te 0 item-uri
        with:
          path: state.json
          key: olx-state-${{ github.run_id }}
